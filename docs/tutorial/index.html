<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ember-concurrency</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
<meta name="dummy/config/environment" content="%7B%22modulePrefix%22%3A%22dummy%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22%2F%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%2C%22_APPLICATION_TEMPLATE_WRAPPER%22%3Afalse%2C%22_DEFAULT_ASYNC_OBSERVERS%22%3Atrue%2C%22_JQUERY_INTEGRATION%22%3Afalse%2C%22_TEMPLATE_ONLY_GLIMMER_COMPONENTS%22%3Atrue%7D%2C%22APP%22%3A%7B%22name%22%3A%22ember-concurrency%22%2C%22version%22%3A%222.3.0%2B36dcaaff%22%7D%2C%22fastboot%22%3A%7B%22hostWhitelist%22%3A%5B%7B%7D%2C%22ember-concurrency.com%22%5D%7D%2C%22exportApplicationGlobal%22%3Afalse%7D" />
<!-- EMBER_CLI_FASTBOOT_TITLE -->

    <link integrity="" rel="stylesheet" href="/assets/vendor-e754b247f0b14ad5fde0f302404dd7cb.css">
    <link integrity="" rel="stylesheet" href="/assets/dummy-57e0f95836c2c702fadf0c8166e5d1e5.css">
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    
  </head>
  <body>
    <script type="x/boundary" id="fastboot-body-start"></script><div class="container navbar">
  <div class="row">
    <div class="ten columns">
      <h3 style="float:left;">
        ember-concurrency

        <span style="font-size: 0.5em;">
          (v 2.3.0)
        </span>
      </h3>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="/api">API</a>
      </div>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="https://github.com/machty/ember-concurrency" target="_blank" rel="noopener noreferrer">GitHub</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="docs row">
    <div class="three columns">
      <div class="side-menu">
            <div class="toc-entry">
                <a id="ember141" class="ember-view" href="/docs/introduction">Home</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember142" class="ember-view" href="/docs/installation">Installation</a>
            </div>


<!---->            <div class="toc-section-title">
              Introduction
            </div>
            <div class="toc-entry">
                <a id="ember143" class="ember-view active" href="/docs/tutorial">Writing Code Without Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember144" class="ember-view" href="/docs/tutorial/discussion">Post-Mortem</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember145" class="ember-view" href="/docs/tutorial/refactor">Refactoring With Tasks</a>
            </div>


<!---->            <div class="toc-section-title">
              Reference
            </div>
            <div class="toc-entry">
                <a id="ember146" class="ember-view" href="/docs/task-function-syntax">Defining Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember147" class="ember-view" href="/docs/task-concurrency">Task Modifiers</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember148" class="ember-view" href="/docs/cancelation">Cancellation</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember149" class="ember-view" href="/docs/error-vs-cancelation">Handling Errors</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember150" class="ember-view" href="/docs/child-tasks">Child Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember151" class="ember-view" href="/docs/derived-state">Derived State</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember152" class="ember-view" href="/docs/events">Awaiting Events / Conditions</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember153" class="ember-view" href="/docs/testing-debugging">Testing &amp; Debugging</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember154" class="ember-view" href="/docs/typescript">TypeScript</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember155" class="ember-view" href="/docs/faq">FAQ &amp; Fact Sheet</a>
            </div>


<!---->            <div class="toc-section-title">
              Advanced
            </div>
            <div class="toc-entry">
                <a id="ember156" class="ember-view" href="/docs/task-concurrency-advanced">Using maxConcurrency</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember157" class="ember-view" href="/docs/advanced/lifecycle-events">Lifecycle Events</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember158" class="ember-view" href="/docs/advanced/task-modifiers">Task Modifiers</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember159" class="ember-view" href="/docs/advanced/yieldables">Yieldables / Controlling Execution</a>
            </div>


<!---->            <div class="toc-section-title">
              Examples
            </div>
            <div class="toc-entry">
                <a id="ember160" class="ember-view" href="/docs/examples/loading-ui">Loading UI</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember161" class="ember-view" href="/docs/examples/autocomplete">Type-Ahead Search</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember162" class="ember-view" href="/docs/examples/increment-buttons">Accelerating Increment Buttons</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember163" class="ember-view" href="/docs/examples/ajax-throttling">AJAX Throttling</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember164" class="ember-view" href="/docs/examples/route-tasks">Route Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a id="ember165" class="ember-view" href="/docs/examples/joining-tasks">Awaiting Multiple Child Tasks</a>
            </div>


<!---->      </div>
    </div>
    <div class="nine columns">
      <div class="row">
    <p class="u-pull-left">
      Previous: <a id="ember166" class="ember-view" href="/docs/installation">Installation</a>
    </p>

    <p class="u-pull-right">
      Next: <a id="ember167" class="ember-view" href="/docs/tutorial/discussion">Post-Mortem</a>
    </p>
</div>

      <a class="github-edit" href="https://github.com/machty/ember-concurrency/edit/master/tests/dummy/app/docs/tutorial/index/template.hbs" title="Edit on GitHub">
  <i class="icon-pencil"></i>
</a>


      <h3>Introduction to ember-concurrency</h3>

<p>
  To demonstrate the kinds of problems ember-concurrency
  is designed to solve, we'll first implement a basic example of
  loading data in a Component using only core Ember APIs. Then
  we'll introduce ember-concurrency tasks as part of a refactor.
</p>

<p>
  This tutorial (and ember-concurrency itself) assumes that you have
  reasonable familiarity with Ember's core APIs, particularly surrounding
  Components, templates, actions, Promises, and the use of <code>async/await</code>.
</p>

<p>
  For our use case, we're going to implement a Component that
  fetches and displays nearby retail stores. This involves
  a two-step asynchronous process:
</p>

<ol>
  <li>
    It uses geolocation to find the user's latitude/longitude coordinates, and then:
  </li>
  <li>
    It forwards those coordinates to the server to fetch a list of nearby restaurants.
  </li>
</ol>

<p>
  <em>
    This is basically the same example demonstrated in this
    <a href="https://youtu.be/VEzVDOmY-dc?t=123">EmberConf ember-concurrency talk</a>;
    take a look if you prefer a video alternative to this tutorial. Please note,
    though, that the coding style has since changed with Ember Octane. The
    examples below have been updated to reflect the newer syntax.
  </em>
</p>

<h4>Version 1: Bare Minimum Implementation</h4>

<p>
  We'll start off a bare-bones implementation of the feature: within
  an action called <code>findStores</code>, we'll create an async function that
  fetches the coordinates from a geolocation service
  and passes those coordinates to a store's <code>getNearbyStores</code>
  method, which eventually gives us an array of stores that we stash
  on the <code>result</code> property so that the stores can be displayed
  in the template.
</p>

<div id="ember168">
  <div class="code-template-toggle">
    <div class="code-template-toggle-section hidden">
      <pre id="ember169" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
    </div>
    <div class="code-template-toggle-section ">
      <pre id="ember170" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial0 extends TutorialComponent {
  result = null;

  @action
  async findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = await geolocation.getCoords();
    let result = await store.getNearbyStores(coords);

    this.set('result', result);
  }
}
</pre>
    </div>
    <span role="button" class="button code-template-toggle-button">
      Toggle JS / Template
    </span>
  </div>
</div>

<div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>


<p>
  This first implementation <em>works</em>, but it's not really production-ready.
  The most immediate problem is that there's no loading UI; the user clicks
  the button and it seems like nothing is happening until the results come back.
</p>

<h4>Version 2: Add a Loading Spinner</h4>

<p>
  We'd like to display a loading spinner while the code is fetching nearby stores.
  In order to do this, we'll add an <code>isFindingStores</code> property to the
  component that the template can use to display a spinner.
</p>

<p>
  <em>
    We'll use <code>++</code> comments to highlight newly added code.
  </em>
</p>

<div id="ember171">
  <div class="code-template-toggle">
    <div class="code-template-toggle-section hidden">
      <pre id="ember172" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
  {{#if this.isFindingStores}}
    {{! ++ }}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
    </div>
    <div class="code-template-toggle-section ">
      <pre id="ember173" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial1 extends TutorialComponent {
  result = null;
  isFindingStores = false; // ++

  @action
  async findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    this.set('isFindingStores', true); // ++

    let coords = await geolocation.getCoords();
    let result = await store.getNearbyStores(coords);

    this.set('result', result);
    this.set('isFindingStores', false); // ++
  }
}
</pre>
    </div>
    <span role="button" class="button code-template-toggle-button">
      Toggle JS / Template
    </span>
  </div>
</div>

<div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>


<p>
  This is certainly an improvement, but strange things start to happen if you
  click the "Find Nearby Stores" button many times in a row.
</p>

<p>
  The problem is that we're kicking off multiple concurrent attempts to fetch
  nearby locations, when really we just want only one fetch to be running
  at any given time.
</p>

<h4>Version 3: Preventing Concurrency</h4>

<p>
  We'd like to prevent another fetch from happening if one is already in
  progress. To do this, just need to add a check to see if
  <code>isFindingStores</code> is true, and return early if so.
</p>

<div id="ember174">
  <div class="code-template-toggle">
    <div class="code-template-toggle-section hidden">
      <pre id="ember175" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
  {{#if this.isFindingStores}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
    </div>
    <div class="code-template-toggle-section ">
      <pre id="ember176" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial2 extends TutorialComponent {
  result = null;
  isFindingStores = false;

  @action
  async findStores() {
    if (this.isFindingStores) { return; } // ++

    let geolocation = this.geolocation;
    let store = this.store;

    this.set('isFindingStores', true);

    let coords = await geolocation.getCoords();
    let result = await store.getNearbyStores(coords);

    this.set('result', result);
    this.set('isFindingStores', false);
  }
}
</pre>
    </div>
    <span role="button" class="button code-template-toggle-button">
      Toggle JS / Template
    </span>
  </div>
</div>

<div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>


<p>
  Now it is safe to tap the "Find Nearby Stores" button. Are we done?
</p>

<p>
  Unfortunately, no. There's an important corner case we haven't addressed yet:
  if the component is destroyed (because the user navigated
  to a different page) while the fetch is running, our code
  will throw an Error with the message
  <code>"calling set on destroyed object"</code>.
</p>

<p>
  You can
  actually verify that this happening by opening your browser's
  web inspector, clicking "Find Nearby Stores" from the example
  above, and then quickly clicking <a id="ember177" class="ember-view" href="/docs/introduction">this link</a>
  before the store results have come back.
</p>

<h4>Version 4: Handling "set on destroyed object" errors</h4>

<p>
  The problem is that it's possible for our promise callback (the
  one that sets <code>result</code> and <code>isFindingStores</code>)
  to run after the component has been destroyed, and Ember (and React
  and many others) will complain if you try and, well, call <code>set()</code>
  on a destroyed object.
</p>

<p>
  Fortunately, Ember let's us check if an object has been destroyed
  via the <code>isDestroyed</code> flag, so we can just add a bit of
  defensive programming to our promise callback as follows:
</p>

<div id="ember178">
  <div class="code-template-toggle">
    <div class="code-template-toggle-section hidden">
      <pre id="ember179" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
  {{#if this.isFindingStores}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
    </div>
    <div class="code-template-toggle-section ">
      <pre id="ember180" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial3 extends TutorialComponent {
  result = null;
  isFindingStores = false;

  @action
  async findStores() {
    if (this.isFindingStores) { return; }

    let geolocation = this.geolocation;
    let store = this.store;

    this.set('isFindingStores', true);

    let coords = await geolocation.getCoords();
    let result = await store.getNearbyStores(coords);

    if (this.isDestroyed) { return; } // ++

    this.set('result', result);
    this.set('isFindingStores', false);
  }
}
</pre>
    </div>
    <span role="button" class="button code-template-toggle-button">
      Toggle JS / Template
    </span>
  </div>
</div>

<div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>


<p>
  Now if you click "Find Nearby Stores" and
  <a id="ember181" class="ember-view" href="/docs/introduction">navigate elsewhere</a>, you won't see
  that pesky error.
</p>

<p>
  Now, are we done?
</p>

<h4>Version 5: Handle Promise/Async Function Rejection</h4>

<p>
  You might have noticed that we don't have any error handling if
  either the <code>getCoords</code> or <code>getNearbyStores</code>
  <code>await</code> calls throw an error.
</p>

<p>
  Even if we were too lazy to build
  an error banner or popup to indicate that something went wrong (and we are),
  the least we could do is make sure that our code gracefully
  recovers from such an error and doesn't wind up in a bad state.
  As it stands, if one of those <code>await</code> calls raises an error,
  <code>isFindingStores</code> would be stuck to <code>true</code>, and
  there'd be no way to try fetching again.
</p>

<p>
  Let's use a <code>finally</code> block to make sure that
  <code>isFindingStores</code> always gets set to <code>false</code>,
  regardless of success or failure. Unfortunately, this also
  means we have to duplicate our <code>isDestroyed</code> check.
</p>

<div id="ember182">
  <div class="code-template-toggle">
    <div class="code-template-toggle-section hidden">
      <pre id="ember183" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
  {{#if this.isFindingStores}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
    </div>
    <div class="code-template-toggle-section ">
      <pre id="ember184" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial4 extends TutorialComponent {
  result = null;
  isFindingStores = false;

  @action
  async findStores() {
    if (this.isFindingStores) { return; }

    let geolocation = this.geolocation;
    let store = this.store;

    this.set('isFindingStores', true);

    try {                                   // ++
      let coords = await geolocation.getCoords();
      let result = await store.getNearbyStores(coords);

      if (this.isDestroyed) { return; }

      this.set('result', result);
    } finally {                             // ++
      if (!this.isDestroyed) {              // ++
        this.set('isFindingStores', false); // ++
      }                                     // ++
    }                                       // ++
  }
}
</pre>
    </div>
    <span role="button" class="button code-template-toggle-button">
      Toggle JS / Template
    </span>
  </div>
</div>

<div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>


<p>
  And there you have it: a reasonably-production ready implementation
  of finding nearby stores.
</p>


      <br> <br> <br> <br>

      <div class="row">
    <p class="u-pull-left">
      Previous: <a id="ember185" class="ember-view" href="/docs/installation">Installation</a>
    </p>

    <p class="u-pull-right">
      Next: <a id="ember186" class="ember-view" href="/docs/tutorial/discussion">Post-Mortem</a>
    </p>
</div>

    </div>
  </div>
</div>


<div id="ember187" class="ember-notify-cn ember-notify-default ember-view"><!----></div>
<script type="x/boundary" id="fastboot-body-end"></script>

    <script src="/assets/vendor-072fcae1f075a0771bc6c86bf50ee233.js"></script>
    <script src="/assets/dummy-edcd28696d778774cdf7f86015e61974.js"></script>

    
  </body>
</html>
